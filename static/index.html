<!doctype html>
<html>
<head>
<meta charset="UTF-8">
<title>Filtra</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="static/css/bootstrap.min.css">
  <link rel="stylesheet" href="static/css/style.css">
  <link rel="stylesheet" href="static/fonts/genericons/genericons.css">
  <link rel="stylesheet" href="static/css/non-responsive.css">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
  <script src="static/js/bootstrap.min.js"></script>
  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
    if(window.location.href.indexOf("filtra.io") > -1){
        ga('create', 'UA-70081756-1', 'auto');
        ga('send', 'pageview');
    }
    
  
  </script>
  <script>
    /**
    * Function that tracks a click on an outbound link in Google Analytics.
    * This function takes a valid URL string as an argument, and uses that URL string
    * as the event label.
    */
    var trackOutboundLink = function(url) {
        if(window.location.href.indexOf("filtra.io") > -1){
            ga('send', 'event', 'outbound', 'click', url, {'hitCallback':
                function () {
                }
            });
        }
       
    }
    
    var trackCategorySelection = function(cat_name){
        if(window.location.href.indexOf("filtra.io") > -1){
            ga('send', 'event', 'configuration change', 'change category', cat_name, {'hitCallback':
             function () {
             }
           });
        }
    }
    
    var trackTimeRangeSelection = function(seconds){
        if(window.location.href.indexOf("filtra.io") > -1){
            ga('send', 'event', 'configuration change', 'change time frame', seconds, {'hitCallback':
             function () {
             }
           });
        }
    }
  </script>
  <script type="text/javascript">
        /*
         *  Start by loading the category structure
         *
         */
        var selected_top_index = 0;
        var selected_secondary_index = -1;
        var selected_third_index = -1;
        
        var time_frame_index = 0;
        var time_frames = [{seconds:900, text:"Past 15 Minutes"}, {seconds:3600, text:"Past Hour"},
                           {seconds:10800, text:"Past 3 Hours"}, {seconds:43200, text:"Today"}];
        
        var category_structure;
        
        var tweets;
        
        var urlRegEx = /((([A-Za-z]{3,9}:(?:\/\/)?)(?:[\-;:&=\+\$,\w]+@)?[A-Za-z0-9\.\-]+|(?:www\.|[\-;:&=\+\$,\w]+@)[A-Za-z0-9\.\-]+)((?:\/[\+~%\/\.\w\-]*)?\??(?:[\-\+=&;%@\.\w]*)#?(?:[\.\!\/\\\w]*))?)/g;

        
        $.getJSON("/category", function(result){
            category_structure = result;
            renderTopNav();
            renderTimeFrame();
            loadTweets();
            loadHandles();
        });
        
        
        function nominateNewHandle() {
            var handle_string = $("#handle_name").val().trim();
            $("#handle_name").val('');
            console.log("running check for: "+handle_string);
            var patt = /^@(\w){1,15}$/;
            if(patt.test(handle_string)){
                console.log("valid twitter handle");
                voteForHandle(handle_string, 1);
            }else{
                alert("Please enter a valid twitter handle");
            }
        }
        
        function voteForHandle(handle_string, value) {
          $.post( "/handle/"+handle_string+"/category/"+currentCatName()+"/upvote/"+value, function( data ) {
            loadHandles();
          });
        }
        
        function currentCatName() {
            var cat_name = ""
            if ((selected_secondary_index != -1) &&(selected_third_index != -1)){
                cat_name = String(category_structure[selected_top_index].children[selected_secondary_index].children[selected_third_index].name);
            }else if (selected_secondary_index != -1) {
                cat_name = String(category_structure[selected_top_index].children[selected_secondary_index].name);
            }else {
                cat_name= String(category_structure[selected_top_index].name);
            }
            return cat_name;
        }
        
        function loadHandles() {
          cat_name = currentCatName()
          console.log("refreshing handles for category: "+cat_name);
          $.getJSON("/category/"+cat_name, function(result){
              var list_elements = "";
              
              $.each(result, function(i, child){
                  list_elements += "<li ";
                  list_elements += (child.tracked == 1) ? "class=\"active\"" : "class=\"none-active\"";
                  list_elements += "<div class=\"handle\">";
                  list_elements += "<img src=\""+child.profile_pic+"\" alt=\""+child.handle+"\" />"+child.handle+"</div>";
                  list_elements += "<ul ";
                  if (child.vote_val == 0) {
                    list_elements += "class=\"nominate\">";
                    list_elements += "<li class=\"up-v\"><a href=\"#\" onclick=\"voteForHandle('"+child.handle+"',1)\"><span class=\"genericon genericon-collapse\"></span></a> <span>"+child.upvotes+"</span></li>";
                    list_elements += "<li class=\"down-v\"><a href=\"#\" onclick=\"voteForHandle('"+child.handle+"',-1)\"><span class=\"genericon genericon-expand\"></span></a> <span>"+child.downvotes+"</span></li>";
                  }else if (child.vote_val==1) {
                    list_elements += "class=\"nominate done-up\">";
                    list_elements += "<li class=\"up-v\"><a href=\"#\"><span class=\"genericon genericon-collapse\"></span></a> <span>"+child.upvotes+"</span></li>";
                    list_elements += "<li class=\"down-v\"><a href=\"#\"><span class=\"genericon genericon-expand\"></span></a> <span>"+child.downvotes+"</span></li>";
                  }else if (child.vote_val == -1) {
                    list_elements += "class=\"nominate done-down\">";
                    list_elements += "<li class=\"up-v\"><a href=\"#\"><span class=\"genericon genericon-collapse\"></span></a> <span>"+child.upvotes+"</span></li>";
                    list_elements += "<li class=\"down-v\"><a href=\"#\"><span class=\"genericon genericon-expand\"></span></a> <span>"+child.downvotes+"</span></li>";
                    
                  }
                  list_elements += "</ul>";
                  list_elements += "<div class=\"clear\"></div></li>";
              });
              $('#list-vote').html(list_elements);
             
          });
        }
        function renderTweets(){
          $("#time").nextAll().remove();
          tweet_html = "";
          console.log("rendering tweets with length: "+tweets.length);
          console.log("last tweet: "+tweets[tweets.length-1].text);
          $.each(tweets, function(i, child){
            tweet_html += "<div class=\"con-tw\">";
            tweet_html += "<div class=\"wrap-user\">";
            tweet_html += "<div class=\"user\"><img src=\""+child.pic+"\"  alt=\""+child.name+"\" />"+child.name+"</div>";
            tweet_html += "<div class=\"time-tw\"><span class=\"genericon genericon-time\"></span>"+child.tweet_count+"</div>";
            tweet_html += "<div class=\"clear\"></div></div>";
            
            tweet_html += "<div class=\"wrap-con-tw\" >";
            tweet_html += child.text.replace(urlRegEx,"<a href='$1'>$1</a>");
            tweet_html += "<div class=\"preview-tw\">";
            if (child.blurb || child.img_url || child.title) {
              tweet_html += "<div class=\"ic-pr\"><span class=\"genericon genericon-show\"></span> Preview</div>";
              tweet_html += "<div class=\"span8\">";
              if (child.img_url) {
                tweet_html += "<img src=\""+child.img_url+"\" width=\"150\"/>";
              }
              if (child.title)  {
                tweet_html += "<a href=\""+child.link_url+"\">"+child.title+"</a>";
              }else{
                console.log(child.text +" has no title");
              }
              if (child.blurb) {
                tweet_html += "<p>"+child.blurb+"</p>";
              }else{
                console.log(child.text +" has no blurb");
              }
              tweet_html += "<div class=\"clear\"></div></div></div>";
            }
            tweet_html += "</div></div>";
          });
          $("#time").after(tweet_html);
        }
        function loadTweets() {
            cat_name = currentCatName();
            tweets = [];
            $.getJSON("/reader/"+cat_name+"/time/"+time_frames[time_frame_index].seconds, function(result){
                tweets = result;
                renderTweets();
                findAndLoadNextPreview();
            });
        }
        
        function findAndLoadNextPreview(){
          tweet = null;
          
          $.each(tweets, function(i, child){
            if (child.checked == 0) {
              tweet = child;
              return false;
            }
          });
          if (tweet == null) {
            console.log("done loading previews");
            return;
          }
          console.log("tweet is: "+tweet);
          console.log("we will now update tweet with id: "+tweet.id);
          $.getJSON("/page_load/twitter_id/"+tweet.id, function(result){
            local_tweet = null;
            
            $.each(tweets, function(i, child){
              if (child.id == result.id) {
                console.log("found match");
                local_tweet = child;
              }
            });
            if (local_tweet != null){
              local_tweet.blurb = result.blurb;
              local_tweet.img_url = result.img_url;
              local_tweet.link_url = result.link_url;
              local_tweet.title = result.title;
              local_tweet.checked = result.checked;
              console.log("finished with tweet: "+tweet.text);
              renderTweets();
              findAndLoadNextPreview();
            }else{
              console.log("we were midway throuhg: "+result.text+" but had to bail");
            }
            
              
          });
        }
        function renderTopNav() {
            top_nav_container = document.getElementById("top_level_nav");
            var top_options_string = "";
            
            $.each(category_structure, function(i, child){
                
                top_options_string += "<li";
                if (selected_top_index == i) {
                    top_options_string += " class=\"active\""
                    $( ".current-page" ).children("a").html(child.name);
                    //TODO: all neighbor elements get populated by child.chilren categories
                    $(".current-page").nextAll().remove();
                    var list_string = "";
                    //var reverseable = child.children.slice();
                    $.each(child.children, function(j, second_level){
                        if (j == selected_secondary_index) {
                            list_string += "<li id=\"sub-nav2\" ><div id=\"wrap-pr\" onclick=\"topChooser("+i+","+j+",-1)\"><a href=\"#\">"
                            list_string += second_level.name + "</a><a href=\"#\"><span class=\"genericon genericon-collapse\"></span></a></div>";
                            if (second_level.children.length>0) {
                                list_string += "<ul>"
                            }
                            $.each(second_level.children, function(k, third_level){
                                if (k == selected_third_index) {
                                    list_string += "<li class=\"current-sub\" onclick=\"topChooser("+i+","+j+","+k+")\"><a href=\"#\">"+third_level.name+"</a></li>";
                                }else{
                                    list_string += "<li><a href=\"#\" onclick=\"topChooser("+i+","+j+","+k+")\">"+third_level.name+"</a></li>";
                                }
                            });
                            if (second_level.children.length>0) {
                                list_string += "</ul>";
                            }
                            list_string += "</li>";
                        
                        } else{
                            list_string += "<li onclick=\"topChooser("+i+","+j+",-1)\"><a href=\"#\">"+second_level.name+"</a><a href=\"#\"><span class=\"genericon genericon-expand\"></span></a></li>";

                        }
                    });
                    $(".current-page").after(list_string);
                    
                    
                }
                top_options_string += " id=\"top_level_id_"+i+"\"><a href=\"#\">"+child.name+"</a></li>";
                
            });
            top_nav_container.innerHTML = top_options_string;
            
            $.each(category_structure, function(i, child){
               $("#top_level_id_"+i).click(function(){ topChooser(i, -1, -1); return false; }); 
            });
            
            
        }

        function topChooser(i, j, k) {
            console.log("UPDATING TOP");
            selected_secondary_index = j;
            selected_third_index = k;
            selected_top_index = i;
            renderTopNav();
            loadTweets();
            loadHandles();
            trackCategorySelection(currentCatName());
        }
        
        function renderTimeFrame() {
            $("#time").empty();
            time_options_string = "";
            $.each(time_frames, function(i, time_frame){
                if (i == time_frame_index) {
                    time_options_string += "<li class=\"current\" onclick=\"selectTimeFrameIndex("+i+")\"><a href=\"#\"><span class=\"genericon genericon-time\"></span>"+time_frame.text
                    +"</a><br/><span class=\"genericon genericon-downarrow\"></span></li>";
            
                }else{
                    time_options_string += "<li onclick=\"selectTimeFrameIndex("+i+")\"><a href=\"#\"><span class=\"genericon genericon-time\"></span>"+time_frame.text+"</a></li>";
                }
            });
            time_options_string += "<div class=\"clear\"></div>";
            $("#time").html(time_options_string);
            
        }
        function selectTimeFrameIndex(new_index) {
            time_frame_index = new_index;
            renderTimeFrame();
            loadTweets();
            trackTimeRangeSelection(time_frames[time_frame_index].seconds);
        }

  </script>
</head>

<body>
<!-- header start -->
<nav class="navbar navbar-inverse navbar-fixed-top">
  <div class="container-fluid top-nav">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#myNavbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>                        
      </button>
      <a class="navbar-brand" href="#"><img src="static/images/logo.png" alt="middle"  align="bottom" /></a> <p id="slogan">A brief summary of social media</p>
      <div class="clear"></div>
    </div>
    <div class="collapse navbar-collapse" id="myNavbar">
      <ul class="nav navbar-nav navbar-right">
        <li><a href="#"><span class="glyphicon glyphicon-user"></span> Login</a></li>
        <li><a href="#"><span class="glyphicon glyphicon-log-in"></span> Register</a></li>
      </ul>
      <ul id="bt-top-nominate">
      	<li id="bt-nom"><a href="#"><span class="genericon genericon-search"></span> Nominate</a></li>
        <li><span class="genericon genericon-checkmark"></span>  5 Votes left <a href="#"><span class="genericon genericon-help"></span></a></li>
        <div class="clear"></div>
      </ul>
    </div>
    <!-- nav start -->
    <ul class="nav navbar-nav" id="top_level_nav">
      <li class="active"><a href="#">Front Page</a></li>
      <li><a href="#">Technology</a></li>
      <li><a href="#">Sports</a></li>
      <li><a href="#">Travel</a></li>
      <li><a href="#">Politics</a></li>
      <li><a href="#">Travel</a></li>
    </ul>
    <!-- nav end -->
  </div>
</nav>
<!-- header end -->
<!-- contents start -->
<div class="container-fluid">
  <div class="row">
    <div class="col-xs-2 wrap-sub-nav">
      <ul id="nav-category" class="sub">
      	<li class="current-page"><a href="#">Sports</a></li>
        <li id="sub-nav2"><div id="wrap-pr"><a href="#">Apple</a><a href="#"><span class="genericon genericon-collapse"></span></a></div>
        	<ul>
            	<li><a href="#">iOS</a></li>
                <li class="current-sub"><a href="#">OS X</a></li>
                <li><a href="#">Watch</a></li>
                <li><a href="#">TV</a></li>
                <li><a href="#">iPhone</a></li>
            </ul>
        </li>
        
        <li><a href="#">Google</a><a href="#"><span class="genericon genericon-expand"></span></a></li>
        <li><a href="#">Microsoft</a><a href="#"><span class="genericon genericon-expand"></span></a></li>
        <li><a href="#">Mobile</a><a href="#"><span class="genericon genericon-expand"></span></a></li>
        <li><a href="#">Game</a><a href="#"><span class="genericon genericon-expand"></span></a></li>
        <li><a href="#">Home</a><a href="#"><span class="genericon genericon-expand"></span></a></li>
        <li class="last-sub"><a href="#">Apps</a><a href="#"><span class="genericon genericon-expand"></span></a></li>

      </ul>
    </div>
    <div class="col-xs-7 col-xs-offset-2 wrap-con-main">
    	<!-- Breadcurmbs start -->
        <ol class="breadcrumb">
          <li><a href="#"><span class="genericon genericon-home"></span> Front Page</a></li>
          <li><a href="#">Library</a></li>
          <li class="active">Data</li>
        </ol>
    	<!-- Breadcurmbs end -->
    	<!-- time start -->
    	<ul id="time">
        	<li class="current"><a href="#"><span class="genericon genericon-time"></span> Past 15 Minutes</a><br/><span class="genericon genericon-downarrow"></span></li>
            <li><a href="#"><span class="genericon genericon-time"></span> Past Hour</a></li>
            <li><a href="#"><span class="genericon genericon-time"></span> Past 3 Hours</a></li>
            <li><a href="#"><span class="genericon genericon-time"></span> Today</a></li>
            <div class="clear"></div>
        </ul>
    	<!-- time end -->
        <!-- tweets start -->
        <div class="con-tw">
        	<div class="wrap-user">
            	<div class="user">
                	<div class="handle-main"><img src="static/images/ic-twitter.png" alt="TechCrunch" /> Tech Crunch</div>
                	<ul class="nominate done-up">
                    	<li class="up-v"><a href="#"><span class="genericon genericon-collapse"></span></a> <span>53</span></li>
                        <li class="down-v"><a href="#"><span class="genericon genericon-expand"></span></a> <span>7</span></li>
                    </ul>
                    <div class="clear"></div>
                </div>
                <div class="time-tw"><span class="genericon genericon-time"></span> 5 min</div>
                <div class="clear"></div>
            </div>
            <div class="wrap-con-tw">
            	20 new ways Facebook is eating the Internet <a href="#">http://on.tcrn.ch/l/ka9B</a>
            </div>
        </div>
        <!-- tweets end -->
        <!-- tweets start -->
        <div class="con-tw">
        	<div class="wrap-user">
            	<div class="user">
                	<div class="handle-main"><img src="static/images/ic-twitter.png" alt="TechCrunch" /> Tech Crunch</div>
                	<ul class="nominate">
                    	<li class="up-v"><a href="#"><span class="genericon genericon-collapse"></span></a> <span>53</span></li>
                        <li class="down-v"><a href="#"><span class="genericon genericon-expand"></span></a> <span>7</span></li>
                    </ul>
                    <div class="clear"></div>
                </div>
                <div class="time-tw"><span class="genericon genericon-time"></span> 5 min</div>
                <div class="clear"></div>
            </div>
            <div class="wrap-con-tw">
            	20 new ways Facebook is eating the Internet <a href="#">http://on.tcrn.ch/l/ka9B</a>
                <div class="preview-tw">
                	<img src="static/images/ic-load.GIF" class="imgpd"/>
                </div>
            </div>
        </div>
        <!-- tweets end -->
        <!-- tweets start -->
        <div class="con-tw">
        	<div class="wrap-user">
            	<div class="user">
                	<div class="handle-main"><img src="static/images/ic-twitter.png" alt="TechCrunch" /> Tech Crunch</div>
                	<ul class="nominate done-down">
                    	<li class="up-v"><a href="#"><span class="genericon genericon-collapse"></span></a> <span>53</span></li>
                        <li class="down-v"><a href="#"><span class="genericon genericon-expand"></span></a> <span>7</span></li>
                    </ul>
                    <div class="clear"></div>
                </div>
                <div class="time-tw"><span class="genericon genericon-time"></span> 5 min</div>
                <div class="clear"></div>
            </div>
            <div class="wrap-con-tw">
            	20 new ways Facebook is eating the Internet <a href="#">http://on.tcrn.ch/l/ka9B</a>
                <div class="preview-tw">
                	<div class="ic-pr"><span class="genericon genericon-show"></span> Preview</div>
					<div class="span8">
                    	<img src="static/images/img-sp.png"/>
                    	<a href="#">SportsCenter on Twitter</a>
                    	<p>Cavaliers guard J.R. Smith crosses over Pacers forward Paul George, sending him to the floor and knocks down the jumper. </p>
                        <div class="clear"></div>
                    </div>
                </div>
            </div>
        </div>
        <!-- tweets end -->
        <!-- tweets start -->
        <div class="con-tw">
        	<div class="wrap-user">
            	<div class="user">
                	<div class="handle-main"><img src="static/images/ic-twitter.png" alt="TechCrunch" /> Tech Crunch</div>
                	<ul class="nominate">
                    	<li class="up-v"><a href="#"><span class="genericon genericon-collapse"></span></a> <span>53</span></li>
                        <li class="down-v"><a href="#"><span class="genericon genericon-expand"></span></a> <span>7</span></li>
                    </ul>
                    <div class="clear"></div>
                </div>
                <div class="time-tw"><span class="genericon genericon-time"></span> 5 min</div>
                <div class="clear"></div>
            </div>
            <div class="wrap-con-tw">
            	20 new ways Facebook is eating the Internet <a href="#">http://on.tcrn.ch/l/ka9B</a>
                <div class="preview-tw">
                	<div class="ic-pr"><span class="genericon genericon-show"></span> Preview</div>
					<div class="span8">
                    	<img src="static/images/img-sp.png"/>
                    	<a href="#">SportsCenter on Twitter</a>
                    	<p>Cavaliers guard J.R. Smith crosses over Pacers forward Paul George, sending him to the floor and knocks down the jumper.</p>
                        <div class="clear"></div>
                    </div>
                </div>
            </div>
        </div>
        <!-- tweets end -->
        <button id="bt-loadmore">Load More</button>
    </div>
    <!-- sidebar start -->
    <div class="col-xs-3">
    	<!-- vote start -->
        <div class="box-side vote-wrap">
        	<h3>Vote <a href="#"><span class="genericon genericon-help"></span></a></h3>
            <ul id="list-vote">
            	<li class="active"><div class="handle"><img src="static/images/ic-twitter.png" alt="TechCrunch" /> @Tech Crunch</div>
                	<ul class="nominate done-up">
                    	<li class="up-v"><a href="#"><span class="genericon genericon-collapse"></span></a> <span>53</span></li>
                        <li class="down-v"><a href="#"><span class="genericon genericon-expand"></span></a> <span>7</span></li>
                    </ul>
                    <div class="clear"></div>
                </li>
                <li class="active"><div class="handle"><img src="static/images/ic-twitter.png" alt="TechCrunch" /> @Bleacher Report LFL</div>
                	<ul class="nominate done-up">
                    	<li class="up-v"><a href="#"><span class="genericon genericon-collapse"></span></a> <span>53</span></li>
                        <li class="down-v"><a href="#"><span class="genericon genericon-expand"></span></a> <span>7</span></li>
                    </ul>
                    <div class="clear"></div>
                </li>
                <li class="active"><div class="handle"><img src="static/images/ic-twitter.png" alt="TechCrunch" /> @Tech Crunch</div>
                	<ul class="nominate done-down">
                    	<li class="up-v"><a href="#"><span class="genericon genericon-collapse"></span></a> <span>53</span></li>
                        <li class="down-v"><a href="#"><span class="genericon genericon-expand"></span></a> <span>7</span></li>
                    </ul>
                    <div class="clear"></div>
                </li>
                <li class="none-active"><div class="handle"><img src="static/images/ic-twitter.png" alt="TechCrunch" /> @Tech Crunch</div>
                	<ul class="nominate new-vote">
                    	<li><a href="#"><span class="genericon genericon-collapse"></span></a></li>
                        <li><a href="#"><span class="genericon genericon-expand"></span></a></li>
                    </ul>
                    <div class="clear"></div>
                </li>
                <li class="none-active"><div class="handle"><img src="static/images/ic-twitter.png" alt="TechCrunch" /> @Tech Crunch</div>
                	<ul class="nominate new-vote">
                    	<li><a href="#"><span class="genericon genericon-collapse"></span></a></li>
                        <li><a href="#"><span class="genericon genericon-expand"></span></a></li>
                    </ul>
                    <div class="clear"></div>
                </li>
            </ul>
        </div>
    	<!-- vote end -->
    </div>
    <!-- sidebar end -->
  </div>
</div>
<!-- contents end -->
</body>
</html>
